#!/bin/bash
# WordPress Restore Script

set -euo pipefail

BACKUP_DIR="/backups"

# Function to restore a WordPress site
restore_site() {
    local site_name=$1
    local backup_timestamp=$2
    local site_path="/var/www/html/$site_name"
    local backup_path="$BACKUP_DIR/$site_name/$backup_timestamp"
    
    if [ ! -d "$backup_path" ]; then
        echo "‚ùå Backup directory $backup_path does not exist"
        return 1
    fi
    
    echo "üîÑ Restoring $site_name from backup $backup_timestamp..."
    
    # Confirm restoration
    read -p "‚ö†Ô∏è  This will overwrite the current site. Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Restoration cancelled"
        return 1
    fi
    
    # Restore database
    if [ -f "$backup_path/database.sql" ]; then
        echo "üíæ Restoring database..."
        wp db import "$backup_path/database.sql" --path="$site_path" --allow-root
    fi
    
    # Restore files
    if [ -f "$backup_path/files.tar.gz" ]; then
        echo "üìÅ Restoring files..."
        rm -rf "$site_path"/*
        tar -xzf "$backup_path/files.tar.gz" -C "$site_path"
        chown -R www-data:www-data "$site_path"
    fi
    
    # Update URLs if needed
    echo "üîó Updating site URLs..."
    wp search-replace "http://localhost" "http://$site_name.127.0.0.1.nip.io" --path="$site_path" --allow-root --dry-run
    
    echo "‚úÖ Restoration completed for $site_name"
}

# List available backups
list_backups() {
    local site_name=$1
    echo "üìã Available backups for $site_name:"
    if [ -d "$BACKUP_DIR/$site_name" ]; then
        ls -la "$BACKUP_DIR/$site_name/" | grep "^d" | awk '{print $9}' | grep -v "^\.$\|^\.\.$"
    else
        echo "No backups found for $site_name"
    fi
}

# Main execution
if [ $# -eq 0 ]; then
    echo "Usage: wp-restore <site_name> [backup_timestamp]"
    echo "       wp-restore <site_name> list"
    echo ""
    echo "Available sites: wordpress1, wordpress2"
    exit 1
elif [ $# -eq 1 ]; then
    list_backups "$1"
elif [ "$2" = "list" ]; then
    list_backups "$1"
else
    restore_site "$1" "$2"
fi