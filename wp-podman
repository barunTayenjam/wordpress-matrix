#!/bin/bash
# Podman-compatible WordPress Development Platform - All-in-One Management Script

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"
DOMAIN_SUFFIX="127.0.0.1.nip.io"
COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"

# Container runtime selection (Docker vs Podman)
CONTAINER_RUNTIME="docker"
if command -v podman >/dev/null 2>&1 && ! command -v docker >/dev/null 2>&1; then
    CONTAINER_RUNTIME="podman"
elif command -v podman >/dev/null 2>&1; then
    # Podman is available, prefer it
    CONTAINER_RUNTIME="podman"
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper functions
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }

# Container runtime wrapper
compose_cmd() {
    if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
        podman-compose "$@"
    else
        docker-compose "$@"
    fi
}

# Check for required tools
check_requirements() {
    local missing_tools=()
    
    if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
        if ! command -v podman-compose >/dev/null 2>&1; then
            missing_tools+=("podman-compose")
        fi
    else
        if ! command -v docker >/dev/null 2>&1; then
            missing_tools+=("docker")
        fi
        if ! command -v docker-compose >/dev/null 2>&1; then
            missing_tools+=("docker-compose")
        fi
    fi
    
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        log_error "Missing required tools: ${missing_tools[*]}"
        if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
            echo ""
            echo "To install podman-compose:"
            echo "  brew install podman-compose"
            echo "  # or"
            echo "  pip install podman-compose"
        else
            echo ""
            echo "To install Docker:"
            echo "  brew install docker docker-compose"
        fi
        return 1
    fi
    
    return 0
}

# Load environment
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    set -a
    source "$PROJECT_ROOT/.env"
    set +a
fi

# Main help
show_help() {
    cat << EOF
ðŸš€ Podman-Ready WordPress Development Platform (Runtime: $CONTAINER_RUNTIME)

Usage: ./wp-podman <command> [options]

Site Management:
  create <name>     Create new WordPress site
  list              List all sites
  start <name>      Start specific site
  stop <name>       Stop specific site
  remove <name>      Remove site
  info <name>       Show site details

Environment Management:
  start             Start all sites and services
  stop              Stop all services
  restart           Restart all services
  status            Show system status
  logs [site]       Show logs (all or specific site)
  clean             Clean up unused resources
  setup             Initial setup for Podman

Development:
  shell <service>   Access container shell (wp, db, nginx)
  url <name>        Show site URLs
  runtime           Show which runtime is being used

Code Quality:
  lint              Run PHP CodeSniffer (WordPress standards)
  fix               Auto-fix CodeSniffer issues
  analyse           Run PHPStan static analysis (Level 9)
  phpmd             Run PHP Mess Detector
  psalm             Run Psalm static analysis
  quality           Run all quality checks
  quick-check       Run essential checks only

Management Tools:
  phpmyadmin        Access phpMyAdmin at http://localhost:8080

Examples:
  ./wp-podman setup              # Initial Podman setup
  ./wp-podman create blog         # Create new site
  ./wp-podman start              # Start everything
  ./wp-podman runtime            # Show runtime info

Runtime: Using $CONTAINER_RUNTIME

EOF
}

# Site discovery
get_sites() {
    local sites=()
    # Get WordPress directories
    for dir in "$PROJECT_ROOT"/wp_*; do
        if [[ -d "$dir" ]]; then
            sites+=("$(basename "$dir" | sed 's/^wp_//')")
        fi
    done
    printf '%s\n' "${sites[@]}" | sort -u
}

# Check if site exists
site_exists() {
    local site_name="$1"
    [[ -d "$PROJECT_ROOT/wp_$site_name" ]]
}

# Get next available port
get_next_port() {
    local max_port=8000
    if [[ -f "$COMPOSE_FILE" ]]; then
        local ports=$(grep -E '"[0-9]+:80"' "$COMPOSE_FILE" 2>/dev/null | sed -E 's/.*"([0-9]+):80".*/\1/' | sort -nr)
        if [[ -n "$ports" ]]; then
            max_port=$(echo "$ports" | head -n 1)
        fi
    fi
    echo $((max_port + 1))
}

# Podman-specific setup
setup_podman() {
    log_info "Setting up Podman environment..."
    
    # Check if Podman is running
    if ! podman machine list >/dev/null 2>&1; then
        log_info "Initializing Podman machine..."
        podman machine init
        podman machine start
    fi
    
    # Ensure podman-compose is available
    if ! command -v podman-compose >/dev/null 2>&1; then
        log_error "podman-compose is required"
        echo "Install with: brew install podman-compose"
        return 1
    fi
    
    # Create necessary directories
    mkdir -p "$PROJECT_ROOT/logs"
    mkdir -p "$PROJECT_ROOT/ssl-certs"
    mkdir -p "$PROJECT_ROOT/config/nginx"
    
    # Create Podman-specific environment file
    if [[ ! -f "$PROJECT_ROOT/.env" ]]; then
        cat > "$PROJECT_ROOT/.env" << EOF
# Podman WordPress Environment
DOMAIN_SUFFIX=127.0.0.1.nip.io
MYSQL_USER=wp_user
MYSQL_PASSWORD=wp_secure_2024
MYSQL_ROOT_PASSWORD=root_secure_2024
WP_DEBUG=true
CONTAINER_RUNTIME=podman
EOF
        log_success "Created .env file for Podman"
    fi
    
    # Create Podman-compatible docker-compose.yml
    if [[ ! -f "$PROJECT_ROOT/docker-compose.yml" ]]; then
        cat > "$PROJECT_ROOT/docker-compose.yml" << 'EOF'
version: '3.8'

networks:
  wp-net:
    driver: bridge

services:
  # Database
  db:
    image: mysql:8.0
    container_name: wp_db
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: wp_main
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - wp_db_data:/var/lib/mysql
    networks:
      - wp-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Cache
  redis:
    image: redis:alpine
    container_name: wp_redis
    restart: unless-stopped
    networks:
      - wp-net
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  # phpMyAdmin
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: wp_phpmyadmin
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      PMA_HOST: db
      PMA_USER: ${MYSQL_USER:-wp_user}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-wp_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    networks:
      - wp-net
    depends_on:
      - db

volumes:
  wp_db_data:
    driver: local
EOF
        log_success "Created Podman-compatible docker-compose.yml"
    fi
    
    log_success "Podman setup complete!"
    echo ""
    echo "Next steps:"
    echo "1. ./wp-podman create <site-name>"
    echo "2. ./wp-podman start"
    echo "3. ./wp-podman runtime"
}

# Create new site
create_site() {
    local site_name="$1"
    
    if [[ -z "$site_name" ]]; then
        read -p "Enter site name: " site_name
    fi
    
    if [[ -z "$site_name" ]]; then
        log_error "Site name required"
        return 1
    fi
    
    if site_exists "$site_name"; then
        log_error "Site '$site_name' already exists"
        return 1
    fi
    
    local port=$(get_next_port)
    local site_dir="$PROJECT_ROOT/wp_$site_name"
    
    log_info "Creating WordPress site: $site_name (using $CONTAINER_RUNTIME)"
    
    # Create directory
    mkdir -p "$site_dir"
    mkdir -p "$PROJECT_ROOT/logs/wp_$site_name"
    
    # Copy WordPress files using container runtime
    log_info "Installing WordPress..."
    if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
        podman run --rm -v "$site_dir":/var/www/html wordpress:latest \
            bash -c "cp -a /usr/src/wordpress/. /var/www/html/ && chown -R www-data:www-data /var/www/html"
    else
        docker run --rm -v "$site_dir":/var/www/html wordpress:latest \
            bash -c "cp -a /usr/src/wordpress/. /var/www/html/ && chown -R www-data:www-data /var/www/html"
    fi
    
    # Add to docker-compose.yml
    log_info "Adding services to docker-compose.yml..."
    cat >> "$COMPOSE_FILE" << EOF

  # WordPress site: $site_name
  wp_$site_name:
    image: wordpress:php8.3-fpm
    container_name: wp_$site_name
    restart: unless-stopped
    ports:
      - "$port:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: \${MYSQL_USER:-wp_user}
      WORDPRESS_DB_PASSWORD: \${MYSQL_PASSWORD:-wp_password}
      WORDPRESS_DB_NAME: ${site_name}_db
      WORDPRESS_DEBUG: \${WP_DEBUG:-true}
    volumes:
      - ./wp_$site_name:/var/www/html
    networks:
      - wp-net
    depends_on:
      db:
        condition: service_healthy

EOF
    
    # Create database
    log_info "Creating database..."
    if compose_cmd ps db 2>/dev/null | grep -q "Up\|running"; then
        if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
            podman exec wp_db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}" \
                -e "CREATE DATABASE IF NOT EXISTS ${site_name}_db;" 2>/dev/null || true
        else
            compose_cmd exec db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}" \
                -e "CREATE DATABASE IF NOT EXISTS ${site_name}_db;" 2>/dev/null || true
        fi
    fi
    
    # Add to .env
    echo "" >> "$PROJECT_ROOT/.env"
    echo "# Site: $site_name" >> "$PROJECT_ROOT/.env"
    echo "$(echo "$site_name" | tr '[:lower:]' '[:upper:]')_PORT=$port" >> "$PROJECT_ROOT/.env"
    
    log_success "Site '$site_name' created successfully"
    echo "URL: http://localhost:$port"
    echo "Container runtime: $CONTAINER_RUNTIME"
    
    # Offer to start the site
    read -p "Start the site now? [Y/n]: " confirm
    if [[ ! "$confirm" =~ ^[Nn]$ ]]; then
        compose_cmd up -d "wp_$site_name"
        log_success "Site '$site_name' started"
    fi
}

# Show runtime information
show_runtime() {
    echo "Container Runtime: $CONTAINER_RUNTIME"
    echo ""
    
    if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
        echo "Podman Information:"
        podman --version
        echo ""
        if command -v podman-compose >/dev/null 2>&1; then
            echo "Podman Compose:"
            podman-compose version 2>/dev/null || echo "Version not available"
        fi
        echo ""
        echo "Podman Machine Status:"
        podman machine list 2>/dev/null || echo "Machine management not available"
    else
        echo "Docker Information:"
        docker --version
        echo ""
        docker-compose --version
        echo ""
        echo "Docker System Info:"
        docker system df 2>/dev/null || echo "Docker not running"
    fi
}

# List all sites
list_sites() {
    log_info "WordPress Sites (Runtime: $CONTAINER_RUNTIME):"
    echo ""
    
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found"
        return
    fi
    
    printf "%-15s %-10s %-30s\n" "Site" "Status" "Local URL"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    
    for site in "${sites[@]}"; do
        local port_var="$(echo "$site" | tr '[:lower:]' '[:upper:]')_PORT"
        local port=$(eval echo "\$$port_var")
        local status="Stopped"
        
        if compose_cmd ps 2>/dev/null | grep "wp_$site" | grep -q "Up\|running"; then
            status="Running"
        fi
        
        printf "%-15s %-10s %-30s\n" "$site" "$status" \
            "http://localhost:${port:-????}"
    done
    echo ""
}

# Start environment
start_env() {
    if ! check_requirements; then
        return 1
    fi
    
    log_info "Starting WordPress environment with $CONTAINER_RUNTIME..."
    compose_cmd up -d db redis phpmyadmin
    sleep 3
    
    # Start all WordPress sites
    for site in $(get_sites); do
        log_info "Starting $site..."
        compose_cmd up -d "wp_$site" 2>/dev/null || true
    done
    
    log_success "Environment started with $CONTAINER_RUNTIME"
    echo ""
    show_runtime
}

# Stop environment
stop_env() {
    log_info "Stopping WordPress environment..."
    compose_cmd down
    log_success "Environment stopped"
}

# Show status
show_status() {
    log_info "System Status (Runtime: $CONTAINER_RUNTIME):"
    echo ""
    compose_cmd ps
    echo ""
    list_sites
}

# Access shell
access_shell() {
    local service="$1"
    
    case "$service" in
        "wp"|"wordpress")
            local sites=($(get_sites))
            if [[ ${#sites[@]} -eq 0 ]]; then
                log_error "No WordPress sites found"
                return 1
            fi
            
            # Use first available site
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman exec -it "wp_${sites[0]}" bash || \
                log_error "WordPress container not running"
            else
                compose_cmd exec "wp_${sites[0]}" bash || \
                log_error "WordPress container not running"
            fi
            ;;
        "db"|"database")
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman exec -it wp_db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}"
            else
                compose_cmd exec db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}"
            fi
            ;;
        *)
            log_error "Unknown service: $service"
            echo "Available: wp, db"
            return 1
            ;;
    esac
}

# --- Code Quality Functions ---

# Run PHP CodeSniffer
run_lint() {
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found to lint"
        return
    fi
    
    log_info "Running PHP CodeSniffer (WordPress standards)..."
    for site in "${sites[@]}"; do
        if [[ -d "./wp_$site/wp-content" ]]; then
            log_info "Linting $site..."
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true && \
                    composer require --dev wp-coding-standards/wpcs && \
                    vendor/bin/phpcs --standard=WordPress --extensions=php ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No custom code found for $site'"
            else
                docker run --rm -v "$PWD:/app" -w /app php:8.3-cli \
                    sh -c "composer require --dev wp-coding-standards/wpcs && \
                    vendor/bin/phpcs --standard=WordPress --extensions=php ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No custom code found for $site'"
            fi
        fi
    done
}

# Auto-fix CodeSniffer issues
run_fix() {
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found to fix"
        return
    fi
    
    log_info "Auto-fixing CodeSniffer issues..."
    for site in "${sites[@]}"; do
        if [[ -d "./wp_$site/wp-content" ]]; then
            log_info "Fixing $site..."
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true && \
                    composer require --dev wp-coding-standards/wpcs && \
                    vendor/bin/phpcbf --standard=WordPress --extensions=php ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No issues to fix for $site'"
            else
                docker run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer require --dev wp-coding-standards/wpcs && \
                    vendor/bin/phpcbf --standard=WordPress --extensions=php ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No issues to fix for $site'"
            fi
        fi
    done
}

# Run PHPStan analysis
run_analyse() {
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found to analyse"
        return
    fi
    
    log_info "Running PHPStan static analysis (Level 9)..."
    for site in "${sites[@]}"; do
        if [[ -d "./wp_$site/wp-content" ]]; then
            log_info "Analyzing $site..."
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true && \
                    composer require --dev phpstan/phpstan && \
                    vendor/bin/phpstan analyse --level=9 --memory-limit=1G ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No code to analyse for $site'"
            else
                docker run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer require --dev phpstan/phpstan && \
                    vendor/bin/phpstan analyse --level=9 --memory-limit=1G ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No code to analyse for $site'"
            fi
        fi
    done
}

# Run PHP Mess Detector
run_phpmd() {
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found to check"
        return
    fi
    
    log_info "Running PHP Mess Detector..."
    for site in "${sites[@]}"; do
        if [[ -d "./wp_$site/wp-content" ]]; then
            log_info "Checking $site..."
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true && \
                    composer require --dev phpmd/phpmd && \
                    vendor/bin/phpmd ./wp_$site/wp-content/themes,./wp_$site/wp-content/plugins text cleancode,codesize,controversial,design,naming,unusedcode 2>/dev/null || echo 'No issues found for $site'"
            else
                docker run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer require --dev phpmd/phpmd && \
                    vendor/bin/phpmd ./wp_$site/wp-content/themes,./wp_$site/wp-content/plugins text cleancode,codesize,controversial,design,naming,unusedcode 2>/dev/null || echo 'No issues found for $site'"
            fi
        fi
    done
}

# Run Psalm analysis
run_psalm() {
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found to analyse"
        return
    fi
    
    log_info "Running Psalm static analysis..."
    for site in "${sites[@]}"; do
        if [[ -d "./wp_$site/wp-content" ]]; then
            log_info "Analyzing $site with Psalm..."
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                podman run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true && \
                    composer require --dev vimeo/psalm && \
                    vendor/bin/psalm --show-info=true ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No code to analyse for $site'"
            else
                docker run --rm -v "$PWD:/app" -w /app composer:2.7 \
                    sh -c "composer require --dev vimeo/psalm && \
                    vendor/bin/psalm --show-info=true ./wp_$site/wp-content/themes ./wp_$site/wp-content/plugins 2>/dev/null || echo 'No code to analyse for $site'"
            fi
        fi
    done
}

# Run all quality checks
run_quality() {
    log_info "Running comprehensive code quality checks..."
    echo ""
    run_lint
    echo ""
    run_analyse
    echo ""
    run_phpmd
    echo ""
    run_psalm
    echo ""
    log_success "All code quality checks completed!"
}

# Run quick quality check
run_quick_check() {
    log_info "Running quick code quality check..."
    echo ""
    run_lint
    echo ""
    run_analyse
    echo ""
    log_success "Quick quality check completed!"
}

# Main command dispatcher
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        return
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        "setup")
            setup_podman "$@"
            ;;
        "runtime")
            show_runtime
            ;;
        "create")
            create_site "$@"
            ;;
        "list"|"ls")
            list_sites "$@"
            ;;
        "start")
            if [[ -n "${1:-}" ]]; then
                compose_cmd up -d "wp_$1"
            else
                start_env "$@"
            fi
            ;;
        "stop")
            if [[ -n "${1:-}" ]]; then
                compose_cmd stop "wp_$1"
            else
                stop_env "$@"
            fi
            ;;
        "restart")
            stop_env
            start_env
            ;;
        "status")
            show_status "$@"
            ;;
        "logs")
            if [[ -n "${1:-}" ]]; then
                compose_cmd logs -f "wp_$1"
            else
                compose_cmd logs -f
            fi
            ;;
        "shell")
            access_shell "$@"
            ;;
        "remove"|"rm")
            local site_name="$1"
            if [[ -z "$site_name" ]]; then
                log_error "Please specify a site to remove"
                return 1
            fi
            
            if ! site_exists "$site_name"; then
                log_error "Site '$site_name' not found"
                return 1
            fi
            
            echo -e "${RED}WARNING: This will permanently delete '$site_name'${NC}"
            read -p "Continue? [y/N]: " confirm
            
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                log_info "Removing site '$site_name'..."
                compose_cmd stop "wp_$site_name" 2>/dev/null || true
                compose_cmd rm -f "wp_$site_name" 2>/dev/null || true
                rm -rf "$PROJECT_ROOT/wp_$site_name"
                log_success "Site '$site_name' removed"
            fi
            ;;
        "clean")
            if [[ "$CONTAINER_RUNTIME" == "podman" ]]; then
                log_info "Cleaning up Podman resources..."
                podman system prune -f
                podman volume prune -f
            else
                log_info "Cleaning up Docker resources..."
                docker system prune -f
                docker volume prune -f
            fi
            log_success "Cleanup complete"
            ;;
        "lint"|"phpcs")
            run_lint
            ;;
        "fix"|"phpcbf")
            run_fix
            ;;
        "analyse"|"analyze"|"phpstan")
            run_analyse
            ;;
        "phpmd")
            run_phpmd
            ;;
        "psalm")
            run_psalm
            ;;
        "quality")
            run_quality
            ;;
        "quick-check"|"quick")
            run_quick_check
            ;;
        "check")
            run_quick_check
            ;;
        "test")
            log_info "Running tests..."
            if [[ -f "$PROJECT_ROOT/tests/test-runner.sh" ]]; then
                "$PROJECT_ROOT/tests/test-runner.sh" all
            else
                log_warning "Test runner not found"
            fi
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            return 1
            ;;
    esac
}

main "$@"