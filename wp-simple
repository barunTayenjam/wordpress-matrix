#!/bin/bash
# Simplified WordPress Development Platform - All-in-One Management Script

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"
DOMAIN_SUFFIX="127.0.0.1.nip.io"
COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper functions
log_info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
log_success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
log_warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
log_error() { echo -e "${RED}‚ùå $1${NC}"; }

# Load environment
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    set -a
    source "$PROJECT_ROOT/.env"
    set +a
fi

# Main help
show_help() {
    cat << EOF
üöÄ Simplified WordPress Development Platform

Usage: ./wp-simple <command> [options]

Site Management:
  create <name>     Create new WordPress site
  list              List all sites
  start <name>      Start specific site
  stop <name>       Stop specific site
  remove <name>     Remove site
  info <name>       Show site details

Environment Management:
  start             Start all sites and services
  stop              Stop all services
  restart           Restart all services
  status            Show system status
  logs [site]       Show logs (all or specific site)
  clean             Clean up unused resources

Code Quality:
  check             Run code quality checks
  test              Run tests
  fix               Auto-fix code issues

Development:
  shell <service>   Access container shell (wp, db, nginx)
  url <name>        Show site URLs

Examples:
  ./wp-simple create blog      # Create new site
  ./wp-simple start            # Start everything
  ./wp-simple check            # Run quality checks
  ./wp-simple shell wp         # Access WordPress CLI

EOF
}

# Site discovery
get_sites() {
    local sites=()
    # Get WordPress directories
    for dir in "$PROJECT_ROOT"/wp_*; do
        if [[ -d "$dir" ]]; then
            sites+=("$(basename "$dir" | sed 's/^wp_//')")
        fi
    done
    printf '%s\n' "${sites[@]}" | sort -u
}

# Check if site exists
site_exists() {
    local site_name="$1"
    [[ -d "$PROJECT_ROOT/wp_$site_name" ]]
}

# Get next available port
get_next_port() {
    local max_port=8000
    if [[ -f "$COMPOSE_FILE" ]]; then
        local ports=$(grep -E 'ports:.*-[0-9]+:80' "$COMPOSE_FILE" 2>/dev/null | sed -E 's/.*-([0-9]+):80.*/\1/' | sort -nr)
        if [[ -n "$ports" ]]; then
            max_port=$(echo "$ports" | head -n 1)
        fi
    fi
    echo $((max_port + 1))
}

# Create new site
create_site() {
    local site_name="$1"
    
    if [[ -z "$site_name" ]]; then
        read -p "Enter site name: " site_name
    fi
    
    if [[ -z "$site_name" ]]; then
        log_error "Site name required"
        return 1
    fi
    
    if site_exists "$site_name"; then
        log_error "Site '$site_name' already exists"
        return 1
    fi
    
    local port=$(get_next_port)
    local site_dir="$PROJECT_ROOT/wp_$site_name"
    
    log_info "Creating WordPress site: $site_name"
    
    # Create directory
    mkdir -p "$site_dir"
    mkdir -p "$PROJECT_ROOT/logs/wp_$site_name"
    
    # Copy WordPress files using Docker
    log_info "Installing WordPress..."
    docker run --rm -v "$site_dir":/var/www/html wordpress:latest \
        bash -c "cp -a /usr/src/wordpress/. /var/www/html/ && chown -R www-data:www-data /var/www/html"
    
    # Add to docker-compose.yml
    log_info "Adding services to docker-compose.yml..."
    cat >> "$COMPOSE_FILE" << EOF

  # WordPress site: $site_name
  wp_$site_name:
    image: wordpress:php8.3-fpm
    container_name: wp_$site_name
    restart: unless-stopped
    ports:
      - "$port:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: \${MYSQL_USER:-wp_user}
      WORDPRESS_DB_PASSWORD: \${MYSQL_PASSWORD:-wp_password}
      WORDPRESS_DB_NAME: ${site_name}_db
      WORDPRESS_DEBUG: \${WP_DEBUG:-true}
    volumes:
      - ./wp_$site_name:/var/www/html
    networks:
      - wp-net

  nginx_$site_name:
    image: nginx:alpine
    container_name: nginx_$site_name
    restart: unless-stopped
    ports:
      - "$((port + 1000)):80"
    depends_on:
      - wp_$site_name
    volumes:
      - ./wp_$site_name:/var/www/html:ro
      - ./config/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - wp-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.$site_name.rule=Host(\`$site_name.$DOMAIN_SUFFIX\`)"

EOF
    
    # Create database
    if docker-compose ps db 2>/dev/null | grep -q "Up"; then
        docker-compose exec db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}" \
            -e "CREATE DATABASE IF NOT EXISTS ${site_name}_db;" 2>/dev/null || true
    fi
    
    # Add to .env
    echo "" >> "$PROJECT_ROOT/.env"
    echo "# Site: $site_name" >> "$PROJECT_ROOT/.env"
    echo "${site_name^^}_PORT=$port" >> "$PROJECT_ROOT/.env"
    
    log_success "Site '$site_name' created successfully"
    echo "URL: http://localhost:$port"
    echo "Domain: https://$site_name.$DOMAIN_SUFFIX"
    
    # Offer to start the site
    read -p "Start the site now? [Y/n]: " confirm
    if [[ ! "$confirm" =~ ^[Nn]$ ]]; then
        docker-compose up -d wp_$site_name nginx_$site_name
        log_success "Site '$site_name' started"
    fi
}

# List all sites
list_sites() {
    log_info "WordPress Sites:"
    echo ""
    
    local sites=($(get_sites))
    if [[ ${#sites[@]} -eq 0 ]]; then
        log_warning "No sites found"
        return
    fi
    
    printf "%-15s %-10s %-30s %-30s\n" "Site" "Status" "Local URL" "Domain URL"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    for site in "${sites[@]}"; do
        local port_var="${site^^}_PORT"
        local port=$(eval echo "\$$port_var")
        local status="Stopped"
        
        if docker-compose ps "wp_$site" 2>/dev/null | grep -q "Up"; then
            status="Running"
        fi
        
        printf "%-15s %-10s %-30s %-30s\n" "$site" "$status" \
            "http://localhost:${port:-????}" \
            "https://$site.$DOMAIN_SUFFIX"
    done
    echo ""
}

# Start environment
start_env() {
    log_info "Starting WordPress environment..."
    docker-compose up -d db redis
    sleep 3
    
    # Start all WordPress sites
    for site in $(get_sites); do
        log_info "Starting $site..."
        docker-compose up -d "wp_$site" "nginx_$site" 2>/dev/null || true
    done
    
    log_success "Environment started"
    echo ""
    echo "Access URLs:"
    list_sites | grep -E "(Running|http|https)"
}

# Stop environment
stop_env() {
    log_info "Stopping WordPress environment..."
    docker-compose down
    log_success "Environment stopped"
}

# Show status
show_status() {
    log_info "System Status:"
    echo ""
    docker-compose ps
    echo ""
    list_sites
}

# Show logs
show_logs() {
    local service="$1"
    
    if [[ -n "$service" ]]; then
        if [[ "$service" == "db" ]]; then
            docker-compose logs -f db
        elif [[ "$service" == "nginx" ]]; then
            docker-compose logs -f traefik
        else
            docker-compose logs -f "wp_$service" "nginx_$service" 2>/dev/null || \
            docker-compose logs -f "$service"
        fi
    else
        docker-compose logs -f
    fi
}

# Remove site
remove_site() {
    local site_name="$1"
    
    if ! site_exists "$site_name"; then
        log_error "Site '$site_name' not found"
        return 1
    fi
    
    echo -e "${RED}WARNING: This will permanently delete '$site_name'${NC}"
    read -p "Continue? [y/N]: " confirm
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        return
    fi
    
    log_info "Removing site '$site_name'..."
    
    # Stop services
    docker-compose stop "wp_$site_name" "nginx_$site_name" 2>/dev/null || true
    docker-compose rm -f "wp_$site_name" "nginx_$site_name" 2>/dev/null || true
    
    # Remove files
    rm -rf "$PROJECT_ROOT/wp_$site_name"
    rm -rf "$PROJECT_ROOT/logs/wp_$site_name"
    
    # Remove database
    if docker-compose ps db 2>/dev/null | grep -q "Up"; then
        docker-compose exec db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}" \
            -e "DROP DATABASE IF EXISTS ${site_name}_db;" 2>/dev/null || true
    fi
    
    log_success "Site '$site_name' removed"
}

# Code quality checks
run_checks() {
    log_info "Running code quality checks..."
    
    # Check if code quality containers exist in docker-compose
    if ! grep -q "phpcs" "$COMPOSE_FILE" 2>/dev/null; then
        log_warning "Code quality tools not configured"
        return
    fi
    
    docker-compose run --rm phpcs phpcs --standard=WordPress \
        ./wp_*/wp-content/themes/ ./wp_*/wp-content/plugins/ 2>/dev/null || \
    log_info "Run 'wp-simple setup' to install code quality tools"
}

# Access shell
access_shell() {
    local service="$1"
    
    case "$service" in
        "wp"|"wordpress")
            local sites=($(get_sites))
            if [[ ${#sites[@]} -eq 0 ]]; then
                log_error "No WordPress sites found"
                return 1
            fi
            
            # Use first available site
            docker-compose exec "wp_${sites[0]}" bash 2>/dev/null || \
            log_error "WordPress container not running"
            ;;
        "db"|"database")
            docker-compose exec db mysql -u root -p"${MYSQL_ROOT_PASSWORD:-root}"
            ;;
        "nginx"|"proxy")
            docker-compose exec traefik sh 2>/dev/null || \
            log_error "Traefik container not running"
            ;;
        *)
            log_error "Unknown service: $service"
            echo "Available: wp, db, nginx"
            return 1
            ;;
    esac
}

# Show URLs
show_urls() {
    local site_name="$1"
    
    if [[ -n "$site_name" ]]; then
        if site_exists "$site_name"; then
            local port_var="${site_name^^}_PORT"
            local port=$(eval echo "\$$port_var")
            echo "Local: http://localhost:${port:-????}"
            echo "Domain: https://$site_name.$DOMAIN_SUFFIX"
        else
            log_error "Site '$site_name' not found"
        fi
    else
        echo "Base URLs:"
        echo "WordPress sites: https://<site>.$DOMAIN_SUFFIX"
        echo "Database admin: https://phpmyadmin.$DOMAIN_SUFFIX"
        echo "Email viewer: https://mailhog.$DOMAIN_SUFFIX"
    fi
}

# Setup environment
setup_env() {
    log_info "Setting up simplified WordPress environment..."
    
    # Create .env if not exists
    if [[ ! -f "$PROJECT_ROOT/.env" ]]; then
        cat > "$PROJECT_ROOT/.env" << EOF
# Simplified WordPress Environment
DOMAIN_SUFFIX=127.0.0.1.nip.io
MYSQL_USER=wp_user
MYSQL_PASSWORD=wp_password
MYSQL_ROOT_PASSWORD=root_password
WP_DEBUG=true
EOF
        log_success "Created .env file"
    fi
    
    # Create simplified docker-compose.yml if not exists
    if [[ ! -f "$PROJECT_ROOT/docker-compose.yml" ]]; then
        cat > "$PROJECT_ROOT/docker-compose.yml" << EOF
version: '3.8'

networks:
  wp-net:
    driver: bridge

services:
  # Database
  db:
    image: mysql:8.0
    container_name: wp_db
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: \${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: wp_main
      MYSQL_USER: \${MYSQL_USER}
      MYSQL_PASSWORD: \${MYSQL_PASSWORD}
    volumes:
      - wp_db_data:/var/lib/mysql
    networks:
      - wp-net

  # Cache
  redis:
    image: redis:alpine
    container_name: wp_redis
    restart: unless-stopped
    networks:
      - wp-net

  # Reverse proxy
  traefik:
    image: traefik:v2.10
    container_name: wp_traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--serverstransport.insecureskipverify=true"
    networks:
      - wp-net

volumes:
  wp_db_data:
EOF
        log_success "Created docker-compose.yml"
    fi
    
    # Create config directories
    mkdir -p "$PROJECT_ROOT/config/nginx"
    
    # Create default nginx config
    if [[ ! -f "$PROJECT_ROOT/config/nginx/default.conf" ]]; then
        cat > "$PROJECT_ROOT/config/nginx/default.conf" << 'EOF'
server {
    listen 80;
    server_name _;
    root /var/www/html;
    index index.php index.html;
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
EOF
        log_success "Created nginx configuration"
    fi
    
    log_success "Setup complete! Run './wp-simple start' to begin"
}

# Clean up
clean_env() {
    log_warning "This will remove unused Docker resources"
    read -p "Continue? [y/N]: " confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        docker system prune -f
        docker volume prune -f
        log_success "Cleanup complete"
    fi
}

# Main command dispatcher
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        return
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        "setup")
            setup_env "$@"
            ;;
        "start")
            start_env "$@"
            ;;
        "stop")
            stop_env "$@"
            ;;
        "restart")
            stop_env
            start_env
            ;;
        "status")
            show_status "$@"
            ;;
        "logs")
            show_logs "$@"
            ;;
        "create")
            create_site "$@"
            ;;
        "list"|"ls")
            list_sites "$@"
            ;;
        "remove"|"rm")
            remove_site "$@"
            ;;
        "info")
            show_urls "$@"
            ;;
        "check"|"quality")
            run_checks "$@"
            ;;
        "test")
            run_checks "$@"  # Same as check for now
            ;;
        "fix")
            log_info "Auto-fix not implemented yet"
            ;;
        "shell")
            access_shell "$@"
            ;;
        "url"|"urls")
            show_urls "$@"
            ;;
        "clean")
            clean_env "$@"
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            show_help
            return 1
            ;;
    esac
}

main "$@"